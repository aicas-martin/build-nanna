node('master') {
    stage ("Run Testsuite on Jamaica 8 on ${config}") {
        script {
            
            def vms = vms_env.split(",")
            def testsets = testsets_env.split(",")
            
            for (String testset : testsets) {
                for (String vm : vms) {
                    stage ("testservice: ${testset} on ${vm}") {
                        def built;
                        try {
                            built= build job: 'Run-Testsuite-Jamaica-8-poc-parameters', parameters: [
                                    [$class: 'StringParameterValue', name: 'configuration', value: config], 
                                    [$class: 'StringParameterValue', name: 'platform', value: platform],
                                    [$class: 'StringParameterValue', name: 'device', value: device],
                                    [$class: 'StringParameterValue', name: 'deviceconfig', value: deviceconfig],
                                    [$class: 'StringParameterValue', name: 'vm', value: vm],
                                    [$class: 'StringParameterValue', name: 'testset', value: testset]
                                ]
                        } catch (Exception e) {}
                        try {
                            copyArtifacts(
                                projectName: 'Run-Testsuite-Jamaica-8-poc-parameters',
                                target: "testresults/${built.number}/",
                                filter: "*.xml",
                                selector: specific("${built.number}")
                            );
                        } catch (Exception e) {}
                    }
                }
            }
        }
        junit "testresults/*/*.xml"
        dir("testresults") {
            deleteDir()
        }
    }
}

